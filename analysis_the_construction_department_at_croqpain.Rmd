---
title: " "
output: html_notebook
---

### Michel's task on finding best new 10 locations challenge will best suited with Regression Analytics when other 60 Locations data is given.

### I have a dataset with 60 location's information with the description below

## Croq'Pain

Data on store earnings and other characteristics for the Croq'Pain case. There should be a total of 60 different stores and 10 potential new outlets. The model used for forecasting should be built on data for the existing 60 stores.

### Variables

-   STOR: Store ID
-   CITY: City in the which store is located. Only provided for potential new outlets
-   EARN: Earnings in \$1,000. Operating earnings: annual sales minus annual operating costs. Operating costs exclude the fixed costs of property rent and equipment rental (all capital equipment is purchased by headquarters and rented to the stores). Operating costs include variable costs such as salaries, utilities, supplies, inventories and other expenses.
-   K: Capital invested in the store in \$1,000. This amount is exactly equal to the purchase price of the property (or the lease, in some cases) plus the cost of all equipment and the cost of remodeling the space.
-   SIZE: Size of store in square meters: Total area inside the store
-   EMPL: Number of employees. Not determined until store is opened
-   P15: Number of 15-24 year olds in a 3 km radius around site in 1,000s
-   P25: Number of 25-34 year olds in a 3 km radius around site 1,000s
-   P35: Number of 35-44 year olds in a 3 km radius around site 1,000s
-   P45: Number of 45-54 year olds in a 3 km radius around site 1,000s
-   P55: Number of persons above 55 in a 3 km radius around site 1,000s
-   total: Total population in 3 km radius around site 1,000s
-   INC: Average income in \$1,000 in town or neighborhood around site
-   COMP: Number of competitors in a 1 km radius around site. Establishments considered as competitors include fast food restaurants, bars and cafes equipped providing lunch service
-   NCOMP: Number of restaurants that do not compete directly with CroqPain in 1 km radius around site
-   NREST: Number of non-restaurant businesses in 1 km radius around site
-   PRICE: Monthly rent per square meter of the retail properties in the same locale.
-   CLI = Cost of Living Index. Measures the cost of living in the immediate vicinity to the restaurant site. Aggregate of average cost of living index determined by the commerce department and additional economic measures taken by experts on site
-   CITY: City name for potential new locations

### Now I will run the corrlation table to see how each data points has the relavance to "EARN" column which is our goal to predict.

Before we read the data, let me load packages for both R & Python.

#### Load R Packages (R)

```{r, message = FALSE}
library(tidyverse)
library(arrow)
library(reticulate)
library(DT)
library(GGally)
library(readr)
library(MASS)
library(gridExtra)
library(patchwork)
library(car)

```


#### Read the data provided (R)

```{r, include = FALSE}
croqpain <- arrow::read_parquet("CroqPain.parquet")


```

```{r}
croqpain %>% 
  DT::datatable()
```


<br> <br>

### Before I fit a linear model, I would like to make sure the distribution of the data if it's a good data to fit a model by looking at Histogram and Scatter Plots.

### I'm looking for a normally distributed data set to avoid the biased result by such as outliers.

#### Creat Histograms (Python)

```{r, message = FALSE}
selected_columns <- c('EARN', 'K', 'SIZE', 'EMPL', 'total', 'P15', 'P25', 'P35', 'P45', 'P55', 'INC', 'PRICE', 'CLI')

# Create a list to store plots
plots <- list()

# Loop through selected columns and create a histogram for each
for (i in seq_along(selected_columns)) {
    col <- selected_columns[i]
    p <- ggplot(croqpain, aes_string(col)) +
        geom_histogram(bins = 15, na.rm = TRUE, fill = "steelblue", color = "black") +
        theme_classic() +
        ggtitle(col)
    plots[[i]] <- p
}

# Print all plots without indices
invisible(lapply(plots, print))
```

### Here, I see some skewness and want to make them normal distribution.

```{r, message = FALSE}
# Selecting the relevant columns for transformation
cols_to_transform <- c('EARN', 'K', 'SIZE', 'INC', 'PRICE', 'CLI')
df_transformed <- croqpain[cols_to_transform]

# Adding a constant to make all values positive
min_value <- min(df_transformed, na.rm = TRUE)
df_transformed <- df_transformed + abs(min_value)

# Applying log transformation (adding a small value to avoid log(0))
# Using log1p which is log(x + 1) to handle zero values
df_transformed <- log1p(df_transformed)

# Create a list to store plots
transformed_plots <- list()

# Plotting histograms after transformation
for (i in seq_along(cols_to_transform)) {
    col <- cols_to_transform[i]
    p <- ggplot(df_transformed, aes_string(col)) +
        geom_histogram(bins = 15, na.rm = TRUE, fill = "steelblue", color = "black") +
        theme_classic() +
        ggtitle(paste('Log Transformed', col))
    transformed_plots[[i]] <- p
}

# Print all transformed plots without indices
invisible(lapply(transformed_plots, print))
```

### K, Price is still Right Skewed, and CLI is left skewed. Let's fix that!

```{r}
# Check if 'K_log' exists in 'df_transformed'
if (!"K_log" %in% names(df_transformed)) {
    # If not, create 'K_log'
    df_transformed$K_log <- log(croqpain$K + 0.01)
}

# Now, create the histogram for 'K_log'
plots[['K_log']] <- ggplot(df_transformed, aes(x = K_log)) +
    geom_histogram(bins = 15, fill = "steelblue", color = "black") +
    labs(x = 'K', y = 'Count', title = 'Log Transformed K') +
    theme_classic()

# Check if 'PRICE_log' exists in 'df_transformed'
if (!"PRICE_log" %in% names(df_transformed)) {
    # If not, create 'PRICE_log'
    df_transformed$PRICE_log <- log(croqpain$PRICE + 0.01)
}

# Now, create the histogram for 'PRICE_log'
plots[['PRICE_log']] <- ggplot(df_transformed, aes(x = PRICE_log)) +
    geom_histogram(bins = 15, fill = "steelblue", color = "black") +
    labs(x = 'PRICE', y = 'Count', title = 'Log Transformed PRICE') +
    theme_classic()

# Check if 'CLI_reflected_log' exists in 'df_transformed'
if (!"CLI_reflected_log" %in% names(df_transformed)) {
    # If not, create 'CLI_reflected_log'
    df_transformed$CLI_reflected_log <- log(max(croqpain$CLI + 1) - croqpain$CLI)
}

# Now, create the histogram for 'CLI_reflected_log'
plots[['CLI_reflected_log']] <- ggplot(df_transformed, aes(x = CLI_reflected_log)) +
    geom_histogram(bins = 15, fill = "steelblue", color = "black") +
    labs(x = 'CLI', y = 'Count', title = 'Reflected Log Transformed CLI') +
    theme_classic()

# Create a list to store the plots
plots <- list()

# Create the log transformed histograms
plots[['K_log']] <- ggplot(df_transformed, aes(x = K_log)) +
    geom_histogram(bins = 15, fill = "steelblue", color = "black") +
    labs(x = 'K', y = 'Count', title = 'Log Transformed K') +
    theme_classic()

plots[['PRICE_log']] <- ggplot(df_transformed, aes(x = PRICE_log)) +
    geom_histogram(bins = 15, fill = "steelblue", color = "black") +
    labs(x = 'PRICE', y = 'Count', title = 'Log Transformed PRICE') +
    theme_classic()

# Create the reflected log transformed histogram
plots[['CLI_reflected_log']] <- ggplot(df_transformed, aes(x = CLI_reflected_log)) +
    geom_histogram(bins = 15, fill = "steelblue", color = "black") +
    labs(x = 'CLI', y = 'Count', title = 'Reflected Log Transformed CLI') +
    theme_classic()

# Print the plots
for (p in plots) {
    print(p)
}


```

### Oh, CLI is still left skewed

```{r, message = FALSE}
# Load the ggplot2 package
library(ggplot2)

# Applying a square transformation to 'CLI'
df_transformed$CLI_squared <- croqpain$CLI^2

# Plotting the histogram for the squared 'CLI' using ggplot2
ggplot(df_transformed, aes(x = CLI_squared)) +
    geom_histogram(bins = 15, fill = "steelblue", color = "black") +
    labs(x = 'CLI', y = 'Count', title = 'Squared Transformed CLI') +
    theme_classic()
```



<br>

## Now, I need to find the best combination of predictor variables for the linear regression model. Using a stepwise selection method or try different combinations of variables and compare their model performance.

#### I willl start with a simple model and manually add variables one by one, checking the Adjusted R-squared or another performance metric each time to see if the new variable improves the model.


```{r}
# Check if 'croqpain_transformed' exists
if (!exists("croqpain_transformed")) {
    # If not, create 'croqpain_transformed'
    croqpain_transformed <- df_transformed  # Replace 'df_transformed' with the name of your transformed data frame
}

# Now, create the models
initial_model <- lm(EARN ~ 1, data=croqpain_transformed)

# Full model: Include all potential predictors
full_model <- lm(EARN ~ ., data=croqpain_transformed)

# Stepwise model selection
stepwise_model <- step(initial_model,
                                             scope = list(lower=initial_model, upper=full_model),
                                             direction="both",
                                             trace=0)  # Set trace=1 to see the steps

# View the summary of the selected model
summary(stepwise_model)
```
